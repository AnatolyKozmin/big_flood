from aiogram import Router, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, ChatMemberUpdated
from sqlalchemy.ext.asyncio import AsyncSession

from database.repositories import ChatRepository

router = Router(name="common")


@router.my_chat_member(F.new_chat_member.status == "member")
async def on_bot_added_to_chat(event: ChatMemberUpdated, session: AsyncSession):
    """–•–µ–Ω–¥–ª–µ—Ä –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ —á–∞—Ç."""
    chat_repo = ChatRepository(session)
    await chat_repo.get_or_create(
        chat_id=event.chat.id,
        title=event.chat.title
    )


@router.message(CommandStart())
async def cmd_start(message: Message, session: AsyncSession):
    """–ö–æ–º–∞–Ω–¥–∞ /start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–∞—Ç–∞."""
    if message.chat.type in ("group", "supergroup"):
        chat_repo = ChatRepository(session)
        await chat_repo.get_or_create(
            chat_id=message.chat.id,
            title=message.chat.title
        )
        await message.answer(
            "üëã –ô–æ! –Ø –±–æ—Ç –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —Ñ–ª—É–¥–∞.\n\n"
            "üìù –ö–æ–º–∞–Ω–¥—ã:\n"
            "‚Ä¢ <code>!–∏–Ω—Ñ–∞ [—Ñ–∞–º–∏–ª–∏—è/—é–∑–µ—Ä–Ω–µ–π–º]</code> ‚Äî –∏–Ω—Ñ–∞ –æ–± –∞–∫—Ç–∏–≤–∏—Å—Ç–µ\n"
            "‚Ä¢ <code>!—Ü–∏—Ç–∞—Ç–∞</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–∏—Ç–∞—Ç—É\n"
            "‚Ä¢ <code>!–º—É–¥—Ä–æ—Å—Ç—å</code> ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞\n"
            "‚Ä¢ <code>!—Ä—É–ª–µ—Ç–∫–∞</code> ‚Äî —à–∞–Ω—Å 1/6 –ø–æ–ª—É—á–∏—Ç—å –º—É—Ç –Ω–∞ 10 –º–∏–Ω\n"
            "‚Ä¢ <code>!—Ä–∞–∑–±—É–¥–∏—Ç—å DD.MM.YYYY HH:MM</code> ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
            "‚Ä¢ <code>!–æ—Ä–≥ –¥–Ω—è</code> ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç–∏–≤–∏—Å—Ç –¥–Ω—è\n"
            "‚Ä¢ <code>!–Ω–∞—Ö—É–π</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî –∞–¥—Ä–µ—Å–Ω—ã–π –æ—Ç–≤–µ—Ç\n"
            "‚Ä¢ <code>!–æ–±–æ—Å–Ω–æ–≤–∞—Ç—å</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî –∞–¥—Ä–µ—Å–Ω—ã–π –æ—Ç–≤–µ—Ç\n"
            "‚Ä¢ <code>!–∫–æ–≥–¥–∞</code> ‚Äî —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ 27.11.2025\n"
            "‚Ä¢ <code>!–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å [—Å–æ–±—ã—Ç–∏–µ]</code> ‚Äî —à–∞–Ω—Å –≤ %\n"
            "‚Ä¢ <code>!–∫—Ç–æ [—Ç–µ–∫—Å—Ç]</code> ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π —á–µ–ª–æ–≤–µ–∫\n"
            "‚Ä¢ <code>!–¥—É–µ–ª—å</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî —Ä–∞–Ω–¥–æ–º–Ω—ã–π –º—É—Ç\n"
            "‚Ä¢ <code>!–º–∞—Ç–¥—É—ç–ª—å</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥—É—ç–ª—å\n"
            "‚Ä¢ <code>!–∞–Ω–º—É—Ç</code> ‚Äî —Ä–∞–∑–º—É—Ç–∏—Ç—å –≤—Å–µ—Ö",
            parse_mode="HTML"
        )
    else:
        await message.answer(
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ä–∞–±–æ—Ç–∞—é —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.\n"
            "–î–æ–±–∞–≤—å –º–µ–Ω—è –≤ –≥—Ä—É–ø–ø—É!"
        )


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /help - —Å–ø—Ä–∞–≤–∫–∞."""
    await message.answer(
        "üìö <b>–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:</b>\n\n"
        "<b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n"
        "‚Ä¢ <code>!–∏–Ω—Ñ–∞ [—Ñ–∞–º–∏–ª–∏—è/—é–∑–µ—Ä–Ω–µ–π–º]</code> ‚Äî –∏–Ω—Ñ–∞ –æ–± –∞–∫—Ç–∏–≤–∏—Å—Ç–µ\n"
        "‚Ä¢ <code>!–æ—Ä–≥ –¥–Ω—è</code> ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π –∞–∫—Ç–∏–≤–∏—Å—Ç –¥–Ω—è\n\n"
        "<b>–¶–∏—Ç–∞—Ç—ã:</b>\n"
        "‚Ä¢ <code>!—Ü–∏—Ç–∞—Ç–∞</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–∏—Ç–∞—Ç—É\n"
        "‚Ä¢ <code>!–º—É–¥—Ä–æ—Å—Ç—å</code> ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞\n\n"
        "<b>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è:</b>\n"
        "‚Ä¢ <code>!—Ä—É–ª–µ—Ç–∫–∞</code> ‚Äî —à–∞–Ω—Å 1/6 –ø–æ–ª—É—á–∏—Ç—å –º—É—Ç –Ω–∞ 10 –º–∏–Ω\n"
        "‚Ä¢ <code>!–¥—É–µ–ª—å</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî —Ä–∞–Ω–¥–æ–º–Ω—ã–π –º—É—Ç\n"
        "‚Ä¢ <code>!–º–∞—Ç–¥—É—ç–ª—å</code> (–≤ –æ—Ç–≤–µ—Ç) ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥—É—ç–ª—å\n"
        "‚Ä¢ <code>!–Ω–∞—Ö—É–π</code> / <code>!–æ–±–æ—Å–Ω–æ–≤–∞—Ç—å</code> (–≤ –æ—Ç–≤–µ—Ç)\n"
        "‚Ä¢ <code>!–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å [—Å–æ–±—ã—Ç–∏–µ]</code> ‚Äî —à–∞–Ω—Å –≤ %\n"
        "‚Ä¢ <code>!–∫—Ç–æ [—Ç–µ–∫—Å—Ç]</code> ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π —á–µ–ª–æ–≤–µ–∫\n\n"
        "<b>–£—Ç–∏–ª–∏—Ç—ã:</b>\n"
        "‚Ä¢ <code>!—Ä–∞–∑–±—É–¥–∏—Ç—å DD.MM.YYYY HH:MM</code> ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
        "‚Ä¢ <code>!–∫–æ–≥–¥–∞</code> ‚Äî —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ 27.11.2025\n"
        "‚Ä¢ <code>!–∞–Ω–º—É—Ç</code> ‚Äî —Ä–∞–∑–º—É—Ç–∏—Ç—å –≤—Å–µ—Ö\n\n"
        "<i>–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã:</i>\n"
        "‚Ä¢ <code>/add_activist</code> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞",
        parse_mode="HTML"
    )
